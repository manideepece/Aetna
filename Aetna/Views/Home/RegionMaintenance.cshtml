@{
    ViewBag.Title = "Regions";
    Layout = "~/Views/Shared/_AetnaLayout.cshtml";
}

<div>&nbsp;</div>
<div>&nbsp;</div>
<div>&nbsp;</div>
<div class="security-page">
    <div style="border-bottom: 1px solid lightgray;padding: 20px;">Region Maintenance</div>
    <div style="padding:50px 20px;">
        <table id="RegionMaintenancegrid"></table>
        <div id="pager2"></div>
    </div>
</div>

<script>
    $(document).ready(function () {
        var lastSelection;
        var selectedCellId;
        var selectedRowId;
        var selectedCellValue;
        $("#RegionMaintenancegrid").jqGrid({
            url: '/Home/RegionMaintenanceData',
            editurl: '/Home/CreateRegionMaintenance',
            datatype: "json",
            mtype: 'Get',
            height: '200px',
            colNames: ['','', 'Region Code', 'Region Description', 'Updated by', 'Updated Date'],
            colModel: [
                {
                    name: 'act', index: 'act', width: 4, align: 'center', search: false, sortable: false, formatter: 'actions',
                    formatoptions: {
                        keys: true,
                        editbutton: false,
                        editformbutton: false,
                        delOptions:
                        {
                            onclickSubmit: function (options, rowid) {
                                options.url = "/Home/DeleteRegionMaintenance"
                            }        
                        }
                    }
                },
                { name: 'REGION_ID', key: true, index: 'REGION_ID', editable: false, hidden: true, editrules: { edithidden: false }, addrules: { addhidden: false, required: false } },
                { name: 'REGION_CD', index: 'REGION_CD', width: 20, editable: true, editrules: { required: false }, search: true, stype: 'text', searchoptions: { sopt: ['cn'] } },
                { name: 'REGION_DESCR', index: 'REGION_DESCR', width: 20, editable: true, editrules: { required: false }, search: true, stype: 'text', searchoptions: { sopt: ['cn'] } },
                { name: 'UPDT_BY_ID', index: 'UPDT_BY_ID', width: 20, editable: false, search: true, stype: 'text', searchoptions: { sopt: ['cn'] } },
                { name: 'UPDT_TMSTMP', index: 'UPDT_TMSTMP', width: 20, type: 'date', editable: false, formatter: "date", search: false },
            ],
            prmNames: { id: "REGION_ID" },
            rowNum: 10,
            rowList: [10, 20, 30],
            pager: '#pager2',
            recordtext: "{0} - {1} of {2} records",
            pgtext: "{0} of {1}",
            pgprev: "Prev",
            pgnext: "Next",
            viewrecords: true,
            sortorder: "desc",
            cellEdit: true,
            cellsubmit: 'remote',
            cellurl: '/Home/EditCellRegionMaintenance',
            beforeEditCell: function (rowid, cellname, value, iRow, iCol) {
                var colData = $("#" + selectedRowId).find('td').eq(selectedCellId).text();
                if (selectedRowId != null && selectedCellId != null && (selectedRowId != iRow || selectedCellId != iCol) && colData != selectedCellValue) {
                    console.log("beforeEditCell " + selectedRowId + " " + selectedCellId)
                    $('#RegionMaintenancegrid').saveCell(selectedRowId, selectedCellId);
                }
            },
            afterEditCell: function (id, name, val, iRow, iCol) {
                selectedRowId = iRow;
                selectedCellId = iCol;
                selectedCellValue = val;
            },
            jsonReader:
            {
                root: "rows",
                page: "page",
                total: "total",
                records: "records",
                repeatitems: false,
                Id: "REGION_ID"
            },
            autowidth: true
        })
            .navGrid('#pager2', { add: false, edit: false, del: false, search: true },
                {},
                {},
                {},
                {
                    closeAfterSearch: true,
                    closeAfterReset: true,
                    closeOnEscape: true
                });
        $("#RegionMaintenancegrid").jqGrid('inlineNav', '#pager2',
            {
                edit: false,
                edittext: "Edit",
                add: true,
                addtext: "Add",
                del: false,
                cancel: true,
                canceltext: "cancel",
                save: true,
                savetext: "Save",
                refresh: false,
                addParams: {
                    addRowParams: {
                        keys: true,
                        url: "/Home/CreateRegionMaintenance",
                        position: "last",
                        aftersavefunc: function (rowid, response, options) {
                            console.log("After Save")
                            var $this = $(this); // grid
                            setTimeout(function () {
                                $(this).trigger("reloadGrid", [{ current: true, fromServer: true }]);
                            }, 1000);
                        }
                        //successfunc: function (val) {
                        //    console.log(val);
                        //    if (val.responseText == 'OK') {
                        //        $(this).jqGrid('setGridParam', { datatype: 'json' }).trigger('reloadGrid');
                        //    }

                        //}
                    }
                }
            }
        );

        function editRow(id) {
            if (id && id !== lastSelection) {
                var grid = $("#RegionMaintenancegrid");
                grid.jqGrid('restoreRow', lastSelection);
                grid.jqGrid('editRow', id, { keys: true });
                lastSelection = id;
            }
        }
    });

</script>  